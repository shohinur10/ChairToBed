<%- include('includes/header') %>

<link rel="stylesheet" type="text/css" href="/css/profile.css" />

<body>
  <div class="profile-container">
    <!-- Modern Header Navigation -->
    <header class="modern-header">
      <div class="header-content">
        <div class="logo-section">
          <h1 class="brand-title">ChairToBed</h1>
          <span class="admin-badge">Admin Panel</span>
        </div>
        <nav class="modern-nav">
          <a href="/admin/" class="nav-item">
            <i class="nav-icon">üè†</i>
            <span>Dashboard</span>
          </a>
          <a href="/admin/product/all" class="nav-item">
            <i class="nav-icon">üì¶</i>
            <span>Products</span>
          </a>
          <a href="/admin/user/all" class="nav-item">
            <i class="nav-icon">üë•</i>
            <span>Users</span>
          </a>
          <a href="/admin/profile" class="nav-item active">
            <i class="nav-icon">üë§</i>
            <span>Profile</span>
          </a>
          <a href="/admin/logout" class="nav-item logout" onclick="return confirm('Do you want to logout?')">
            <i class="nav-icon">üö™</i>
            <span>Logout</span>
          </a>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <!-- Profile Section -->
        <section class="profile-section">
          <div class="section-header">
            <div class="header-left">
              <h2 class="section-title">My Profile</h2>
              <p class="section-subtitle">Manage your account information and settings</p>
            </div>
            <div class="profile-status">
              <div class="status-indicator status-<%= member.memberStatus.toLowerCase() %>">
                <i class="status-icon">
                  <%= member.memberStatus === 'ACTIVE' ? '‚úÖ' : 
                      member.memberStatus === 'BLOCK' ? 'üö´' : 'üóëÔ∏è' %>
                </i>
                <%= member.memberStatus %>
              </div>
            </div>
          </div>

          <!-- Profile Card -->
          <div class="profile-card">
            <div class="profile-card-header">
              <h3 class="card-title">
                <i class="title-icon">üë§</i>
                Profile Information
              </h3>
            </div>

            <div class="profile-content-wrapper">
              <!-- Profile Photo Section -->
              <div class="profile-photo-section">
                <div class="photo-display">
                  <div class="current-photo">
                    <img id="profile-image-display" 
                         src="<%= member.memberImage ? '/' + member.memberImage : '/img/default.jpeg' %>" 
                         alt="Profile Photo" 
                         class="profile-img" />
                    <div class="photo-overlay">
                      <i class="camera-icon">üì∑</i>
                    </div>
                  </div>
                  <div class="photo-info">
                    <h4 class="member-name"><%= member.memberNick %></h4>
                    <span class="member-type-badge member-type-<%= member.memberType.toLowerCase() %>">
                      <%= member.memberType %>
                    </span>
                  </div>
                </div>

                <!-- Image Upload Form -->
                <div class="upload-section">
                  <form id="member-image-upload-form" enctype="multipart/form-data" method="POST" class="upload-form">
                    <div class="upload-area" onclick="document.getElementById('member-image-file-input').click()">
                      <i class="upload-icon">üì∏</i>
                      <span class="upload-text">Click to change photo</span>
                      <small class="upload-hint">JPEG, PNG (max 5MB)</small>
                    </div>
                    <input type="file" 
                           id="member-image-file-input" 
                           name="memberImage"
                           accept="image/jpeg,image/jpg,image/png"
                           style="display: none;" />
                    
                    <div class="upload-controls">
                      <div class="file-info">
                        <span id="selected-file-name" class="file-name"></span>
                      </div>
                      <button type="submit" class="btn-modern btn-primary" id="upload-image-btn" disabled>
                        <i class="btn-icon">üì∏</i>
                        Update Photo
                      </button>
                    </div>
                    <div id="upload-status" class="upload-status"></div>
                  </form>
                </div>
              </div>

              <!-- Profile Details Section -->
              <div class="profile-details-section">
                <div class="details-grid">
                  <div class="detail-item">
                    <div class="detail-label">
                      <i class="detail-icon">üë§</i>
                      Username
                    </div>
                    <div class="detail-value"><%= member.memberNick %></div>
                  </div>

                  <div class="detail-item">
                    <div class="detail-label">
                      <i class="detail-icon">üìû</i>
                      Phone Number
                    </div>
                    <div class="detail-value"><%= member.memberPhone %></div>
                  </div>

                  <div class="detail-item">
                    <div class="detail-label">
                      <i class="detail-icon">üè∑Ô∏è</i>
                      Account Type
                    </div>
                    <div class="detail-value">
                      <span class="type-badge type-<%= member.memberType.toLowerCase() %>">
                        <%= member.memberType %>
                      </span>
                    </div>
                  </div>

                  <div class="detail-item">
                    <div class="detail-label">
                      <i class="detail-icon">‚≠ê</i>
                      Points
                    </div>
                    <div class="detail-value">
                      <span class="points-badge">
                        <%= member.memberPoints || 0 %> pts
                      </span>
                    </div>
                  </div>

                  <div class="detail-item">
                    <div class="detail-label">
                      <i class="detail-icon">üìÖ</i>
                      Member Since
                    </div>
                    <div class="detail-value">
                      <%= new Date(member.createAt).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                      }) %>
                    </div>
                  </div>

                  <div class="detail-item">
                    <div class="detail-label">
                      <i class="detail-icon">üîÑ</i>
                      Last Updated
                    </div>
                    <div class="detail-value">
                      <%= new Date(member.updatedAt || member.createAt).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                      }) %>
                    </div>
                  </div>
                </div>

                <!-- Additional Information -->
                <div class="additional-info">
                  <h4 class="info-title">Account Information</h4>
                  <div class="info-content">
                    <% if (member.memberDesc) { %>
                      <div class="info-item">
                        <div class="info-label">
                          <i class="info-icon">üìù</i>
                          Description
                        </div>
                        <div class="info-value"><%= member.memberDesc %></div>
                      </div>
                    <% } %>
                    
                    <% if (member.memberAddress) { %>
                      <div class="info-item">
                        <div class="info-label">
                          <i class="info-icon">üìç</i>
                          Address
                        </div>
                        <div class="info-value"><%= member.memberAddress %></div>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    console.log("üöÄ MODERN PROFILE PAGE");
    
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('member-image-file-input');  
        const uploadBtn = document.getElementById('upload-image-btn');
        const fileNameSpan = document.getElementById('selected-file-name');
        const statusDiv = document.getElementById('upload-status');
        const profileImg = document.getElementById('profile-image-display');
        const form = document.getElementById('member-image-upload-form');

        console.log('üìã Elements initialized:', {
            fileInput: !!fileInput,
            uploadBtn: !!uploadBtn,
            form: !!form
        });

        // File selection handler
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            console.log('üìÅ File selected:', file?.name);
            
            if (!file) {
                fileNameSpan.textContent = '';
                uploadBtn.disabled = true;
                statusDiv.textContent = '';
                return;
            }

            // File validation
            const validTypes = ['image/jpg', 'image/jpeg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                alert('‚ùå Invalid file type! Please select JPEG or PNG files only.');
                this.value = '';
                fileNameSpan.textContent = '';
                uploadBtn.disabled = true;
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå File too large! Please select a file smaller than 5MB.');
                this.value = '';
                fileNameSpan.textContent = '';
                uploadBtn.disabled = true;
                return;
            }

            // Show selected file
            fileNameSpan.textContent = file.name;
            uploadBtn.disabled = false;
            statusDiv.textContent = 'Ready to upload';
            statusDiv.className = 'upload-status status-ready';

            // Image preview
            const reader = new FileReader();
            reader.onload = function(e) {
                profileImg.src = e.target.result;
                profileImg.parentElement.classList.add('has-preview');
            };
            reader.readAsDataURL(file);
        });

        // Form submission handler
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const file = fileInput.files[0];
            if (!file) {
                alert('‚ùå Please select a file first!');
                return;
            }

            console.log('üî• Starting upload:', file.name, file.type, file.size);

            // Create FormData
            const formData = new FormData();
            formData.append('memberImage', file);
            
            // Update UI
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="btn-icon">‚è≥</i> Uploading...';
            statusDiv.textContent = 'Uploading your photo...';
            statusDiv.className = 'upload-status status-uploading';

            // Upload via fetch
            fetch('/member/update-image', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('üì• Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Upload successful:', data);
                
                // Success feedback
                statusDiv.textContent = '‚úÖ Photo updated successfully!';
                statusDiv.className = 'upload-status status-success';
                
                // Update image if provided
                if (data.member?.memberImage) {
                    profileImg.src = '/' + data.member.memberImage;
                }
                
                // Reset form
                form.reset();
                fileNameSpan.textContent = '';
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="btn-icon">üì∏</i> Update Photo';
                
                // Clear status after delay
                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.className = 'upload-status';
                }, 3000);
            })
            .catch(error => {
                console.error('‚ùå Upload failed:', error);
                
                // Error feedback
                statusDiv.textContent = '‚ùå Upload failed! Please try again.';
                statusDiv.className = 'upload-status status-error';
                
                // Reset button
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="btn-icon">üì∏</i> Update Photo';
            });
        });
    });
  </script>
</body>

<%- include('includes/footer') %> 